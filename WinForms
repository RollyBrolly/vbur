Imports System.Globalization
Imports System.Linq

Public Class facultyDashboard

    Private Const MaxTasks As Integer = 3
    Private Const MaxTaskTextLength As Integer = 20
    Private ReadOnly TaskStartTop As Integer = 119
    Private ReadOnly TaskLeft As Integer = 33
    Private ReadOnly TaskSpacing As Integer = 67

    ' runtime-only label for AM/PM of last timeout
    Private lastOutAmPm As Label
    Private ReadOnly clockTimer As New Timer() With {.Interval = 1000} ' updates every second

    ' ---------------- FORM LOAD ----------------
    Private Sub studentDashboard_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Me.FormBorderStyle = FormBorderStyle.None
        Me.WindowState = FormWindowState.Maximized

        ' Wire buttons (always present)
        AddHandler Button1.Click, AddressOf ButtonAddTask_Click
        AddHandler Button3.Click, AddressOf ButtonCompleteSelected_Click

        ' Attempt to wire up any design-time checkboxes if they exist.
        ' Use Controls.Find so we don't get compile errors if those controls were removed from designer.
        For i As Integer = 1 To 3
            Dim found() As Control = Me.Controls.Find($"CheckBox{i}", True)
            If found IsNot Nothing AndAlso found.Length > 0 AndAlso TypeOf found(0) Is CheckBox Then
                AddHandler DirectCast(found(0), CheckBox).CheckedChanged, AddressOf TaskCheckChanged
            End If
        Next

        ' Do NOT clear Panel1 here — keep any design-time tasks if present.
        ReflowTasks()

        ' Configure announcements to match pending tasks visually and layout
        ConfigureAnnouncements()
        ReflowAnnouncements()

        ' Initialize time system
        Button2.Text = If(String.IsNullOrWhiteSpace(Button2.Text), "TIME IN", Button2.Text)

        ' Start clock for "Time Today"
        AddHandler clockTimer.Tick, AddressOf UpdateTimeToday
        clockTimer.Start()
        UpdateTimeToday(Nothing, EventArgs.Empty)

        ' Initialize Last Time Out (start blank and hide AM/PM)
        Label7.Text = ""
        CreateOrConfigureLastOutAmPmLabel()
        If lastOutAmPm IsNot Nothing Then
            lastOutAmPm.Text = ""
            lastOutAmPm.Visible = False
        End If

        ' Label alignment and centering
        Label7.AutoSize = False
        Label7.TextAlign = ContentAlignment.MiddleCenter
        CenterTimeLabels()
        AddHandler Panel3.Resize, AddressOf Panel3_Resize
        ' Also keep announcement panel centered when form resizes
        AddHandler Panel4.Resize, AddressOf Panel4_Resize
    End Sub

    ' ---------------- ANNOUNCEMENTS: style and layout to match pending tasks ----------------
    Private Sub ConfigureAnnouncements()
        ' Find Panel4 (Announcements) and style its checkboxes and label similar to pending tasks
        If Panel4 Is Nothing Then Return

        ' Ensure the announcement header (Label8) uses the same visual style as pending tasks header
        Try
            Label8.Font = New Font("Segoe UI", 26.25F, FontStyle.Bold)
            Label8.ForeColor = Color.Indigo
        Catch
            ' ignore if Label8 doesn't exist or font assignment fails
        End Try

        ' Style each CheckBox inside Panel4 to match pending tasks
        Dim announceCheckboxes = Panel4.Controls.OfType(Of CheckBox)().OrderBy(Function(c) c.TabIndex).ToList()
        For Each cb In announceCheckboxes
            cb.AutoSize = True
            cb.Font = New Font("Segoe UI", 24.0F, FontStyle.Bold)
            cb.ForeColor = Color.Indigo
            cb.UseVisualStyleBackColor = True
            cb.Left = TaskLeft
        Next
    End Sub

    Private Sub ReflowAnnouncements()
        If Panel4 Is Nothing Then Return

        Dim announceCheckboxes = Panel4.Controls.OfType(Of CheckBox)().OrderBy(Function(c) c.TabIndex).ToList()
        ' Start under the announcement header — pick a start top that matches visual spacing used for tasks
        Dim announcementStartTop As Integer = 130
        For i As Integer = 0 To announceCheckboxes.Count - 1
            Dim cb = announceCheckboxes(i)
            cb.Top = announcementStartTop + (i * TaskSpacing)
        Next

        ' Center the announcement header (Label8) horizontally in the panel
        If Label8 IsNot Nothing Then
            Label8.AutoSize = False
            Label8.TextAlign = ContentAlignment.MiddleCenter
            Label8.Width = Math.Max(100, Panel4.ClientSize.Width - 40)
            Label8.Left = (Panel4.ClientSize.Width - Label8.Width) \ 2
        End If
    End Sub

    Private Sub Panel4_Resize(sender As Object, e As EventArgs)
        ReflowAnnouncements()
    End Sub

    ' ---------------- CLOCK ----------------
    Private Sub UpdateTimeToday(sender As Object, e As EventArgs)
        ' Update with seconds so it visibly changes
        Label5.Text = $"Time Today: {DateTime.Now.ToString("h:mm:ss tt", CultureInfo.InvariantCulture)}"
    End Sub

    ' ---------------- CREATE/CONFIGURE AMPM LABEL ----------------
    Private Sub CreateOrConfigureLastOutAmPmLabel()
        If lastOutAmPm Is Nothing Then
            lastOutAmPm = New Label() With {
                .Name = "LabelLastOutAMPM",
                .AutoSize = True,
                .Font = New Font(Label7.Font.FontFamily, 18.0F, FontStyle.Bold),
                .ForeColor = Label7.ForeColor,
                .BackColor = Color.Transparent,
                .Text = ""
            }
            ' Add to the same parent as Label7 (Panel3 assumed)
            Panel3.Controls.Add(lastOutAmPm)
        Else
            ' Ensure visual consistency
            lastOutAmPm.Font = New Font(Label7.Font.FontFamily, 18.0F, FontStyle.Bold)
            lastOutAmPm.ForeColor = Label7.ForeColor
            lastOutAmPm.BackColor = Color.Transparent
        End If
    End Sub

    ' ---------------- CENTER LABELS ----------------
    Private Sub Panel3_Resize(sender As Object, e As EventArgs)
        CenterTimeLabels()
    End Sub

    Private Sub CenterTimeLabels()
        Dim horizontalPadding As Integer = 20
        Dim spacing As Integer = 8
        Dim maxLabel7Width As Integer = Math.Max(100, Panel3.ClientSize.Width - (horizontalPadding * 2) - 60)
        Label7.Width = maxLabel7Width

        Dim ampmWidth As Integer = If(lastOutAmPm IsNot Nothing, lastOutAmPm.PreferredSize.Width, 0)
        Dim combinedWidth As Integer = Label7.Width + spacing + ampmWidth
        Dim groupLeft As Integer = Math.Max(0, (Panel3.ClientSize.Width - combinedWidth) \ 2)

        Label7.Left = groupLeft
        If lastOutAmPm IsNot Nothing Then
            lastOutAmPm.Left = Label7.Left + Label7.Width + spacing
            lastOutAmPm.Top = Label7.Top + Math.Max(0, (Label7.Height - lastOutAmPm.Height) \ 2)
        End If
    End Sub

    ' ---------------- ADD TASK ----------------
    Private Sub ButtonAddTask_Click(sender As Object, e As EventArgs)
        Dim currentTasks = Panel1.Controls.OfType(Of CheckBox)().ToList()
        If currentTasks.Count >= MaxTasks Then
            MessageBox.Show($"You can only have up to {MaxTasks} pending tasks.", "Task Limit", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If

        Dim taskText As String = Microsoft.VisualBasic.Interaction.InputBox("Enter task description:", "Add Task").Trim()
        If String.IsNullOrWhiteSpace(taskText) Then Return
        If taskText.Length > MaxTaskTextLength Then
            MessageBox.Show($"Task description too long. Shorten it and try again.", "Task Too Long", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If

        Dim cb As New CheckBox() With {
            .AutoSize = True,
            .Font = New Font("Segoe UI", 24.0F, FontStyle.Bold),
            .ForeColor = Color.Indigo,
            .Left = TaskLeft,
            .Text = taskText,
            .UseVisualStyleBackColor = True
        }
        AddHandler cb.CheckedChanged, AddressOf TaskCheckChanged
        Panel1.Controls.Add(cb)
        ReflowTasks()
    End Sub

    ' ---------------- TASK CHECKED ----------------
    Private Sub TaskCheckChanged(sender As Object, e As EventArgs)
        Dim cb = TryCast(sender, CheckBox)
        If cb Is Nothing OrElse Not cb.Checked Then Return

        If MessageBox.Show("Complete this task?", "Complete Task", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
            Panel1.Controls.Remove(cb)
            cb.Dispose()
            ReflowTasks()
        Else
            cb.Checked = False
        End If
    End Sub

    ' ---------------- COMPLETE ALL TASKS ----------------
    Private Sub ButtonCompleteSelected_Click(sender As Object, e As EventArgs)
        Dim tasks = Panel1.Controls.OfType(Of CheckBox)().ToList()
        If tasks.Count = 0 Then
            MessageBox.Show("There are no tasks to complete.", "Complete Tasks", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Return
        End If

        If MessageBox.Show($"Complete and erase all {tasks.Count} task(s)?", "Complete All Tasks", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
            For Each cb In tasks
                Panel1.Controls.Remove(cb)
                cb.Dispose()
            Next
            ReflowTasks()
        End If
    End Sub

    ' ---------------- REFLOW TASKS ----------------
    Private Sub ReflowTasks()
        Dim tasks = Panel1.Controls.OfType(Of CheckBox)().ToList()
        For i As Integer = 0 To tasks.Count - 1
            Dim cb = tasks(i)
            cb.Left = TaskLeft
            cb.Top = TaskStartTop + (i * TaskSpacing)
        Next
    End Sub

    ' ---------------- RETURN TO LOGIN ----------------
    Private Sub PictureBox7_Click(sender As Object, e As EventArgs) Handles PictureBox7.Click
        If MessageBox.Show("Return to login page?", "Confirm", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
            Dim loginForm As New Login()
            loginForm.Show()
            Me.Hide()
        End If
    End Sub

    ' ---------------- TIME IN / TIME OUT ----------------
    Private Sub Button2_Click(sender As Object, e As EventArgs) Handles Button2.Click
        Dim now As DateTime = DateTime.Now
        Dim timeOnly As String = now.ToString("h:mm tt", CultureInfo.InvariantCulture)

        If String.Equals(Button2.Text.Trim(), "TIME IN", StringComparison.OrdinalIgnoreCase) Then
            ' TIME IN
            Label5.Text = $"Time Today: {timeOnly}"
            MessageBox.Show($"You are timed in at {timeOnly}", "Time In", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Button2.Text = "TIME OUT"
        Else
            ' TIME OUT - set label text and show AM/PM next to it
            Label7.Text = now.ToString("MMMM dd, yyyy - h:mm", CultureInfo.InvariantCulture)
            CreateOrConfigureLastOutAmPmLabel()
            lastOutAmPm.Text = now.ToString("tt", CultureInfo.InvariantCulture).ToUpperInvariant()
            lastOutAmPm.Visible = True

            MessageBox.Show($"You are timed out at {timeOnly}", "Time Out", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Button2.Text = "TIME IN"
        End If

        CenterTimeLabels()
    End Sub

    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles Button1.Click

    End Sub
End Class